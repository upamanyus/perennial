(* autogenerated from github.com/mit-pdos/gokv/dmvcc/txnmgr *)
From Perennial.goose_lang Require Import prelude.
From Goose Require github_dot_com.tchajed.goose.machine.
From Goose Require sync.

Section code.
Context `{ext_ty: ext_types}.
Local Coercion Var' s: expr := Var s.

(* clerk.go *)

Definition Clerk := struct.decl [
].

(* server.go *)

Definition Server := struct.decl [
  "mu" :: ptrT;
  "p" :: ProphIdT;
  "nextTid" :: uint64T
].

Definition MakeServer: val :=
  rec: "MakeServer" <> :=
    let: "p" := machine.NewProph #() in
    let: "txnMgr" := struct.new Server [
      "p" ::= "p";
      "nextTid" ::= #1
    ] in
    struct.storeF Server "mu" "txnMgr" (struct.alloc sync.Mutex (zero_val (struct.t sync.Mutex)));;
    "txnMgr".

Definition Server__New: val :=
  rec: "Server__New" "txnMgr" :=
    sync.Mutex__Lock (struct.loadF Server "mu" "txnMgr");;
    let: "tid" := struct.loadF Server "nextTid" "txnMgr" in
    struct.storeF Server "nextTid" "txnMgr" ((struct.loadF Server "nextTid" "txnMgr") + #1);;
    sync.Mutex__Unlock (struct.loadF Server "mu" "txnMgr");;
    "tid".

End code.
