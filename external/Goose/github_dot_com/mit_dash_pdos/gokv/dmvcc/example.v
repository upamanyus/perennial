(* autogenerated from github.com/mit-pdos/gokv/dmvcc/example *)
From Perennial.goose_lang Require Import prelude.
From Goose Require github_dot_com.mit_dash_pdos.gokv.dmvcc.index.
From Goose Require github_dot_com.mit_dash_pdos.gokv.dmvcc.txn.
From Goose Require github_dot_com.mit_dash_pdos.gokv.dmvcc.txncoordinator.
From Goose Require github_dot_com.mit_dash_pdos.gokv.dmvcc.txnmgr.
From Goose Require github_dot_com.tchajed.goose.machine.

Section code.
Context `{ext_ty: ext_types}.
Local Coercion Var' s: expr := Var s.

Definition main: val :=
  rec: "main" <> :=
    let: "indexHost" := index.MakeServer #() in
    let: "txnMgrHost" := txnmgr.MakeServer #() in
    let: "txnCoordHost" := txncoordinator.MakeServer "indexHost" in
    Fork (let: "txnCk" := txn.Begin "txnMgrHost" "txnCoordHost" "indexHost" in
          txn.Clerk__DoTxn "txnCk" (λ: "t",
            txn.Clerk__Put "t" #0 #(str"hello");;
            txn.Clerk__Put "t" #1 #(str"world");;
            #true
            ));;
    Fork (let: "txnCk" := txn.Begin "txnMgrHost" "txnCoordHost" "indexHost" in
          txn.Clerk__DoTxn "txnCk" (λ: "t",
            (if: (StringLength (txn.Clerk__Get "t" #0)) > #0
            then machine.Assert ((StringLength (txn.Clerk__Get "t" #1)) > #0)
            else #());;
            (* log.Printf("Val on txn2: '%s'", t.Get(1)) *)
            #true
            ));;
    machine.Sleep #100000000;;
    #().

End code.
